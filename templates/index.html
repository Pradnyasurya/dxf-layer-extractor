<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DXF Layer Validator</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <div class="page-wrapper">
        <div class="container container--sm">
            <div class="container__header">
                <div class="page-header">
                    <div class="page-header__icon">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M9 12h3.75M9 15h3.75M9 18h3.75m3 .75H18a2.25 2.25 0 002.25-2.25V6.108c0-1.135-.845-2.098-1.976-2.192a48.424 48.424 0 00-1.123-.08m-5.801 0c-.065.21-.1.433-.1.664 0 .414.336.75.75.75h4.5a.75.75 0 00.75-.75 2.25 2.25 0 00-.1-.664m-5.8 0A2.251 2.251 0 0113.5 2.25H15c1.012 0 1.867.668 2.15 1.586m-5.8 0c-.376.023-.75.05-1.124.08C9.095 4.01 8.25 4.973 8.25 6.108V8.25m0 0H4.875c-.621 0-1.125.504-1.125 1.125v11.25c0 .621.504 1.125 1.125 1.125h9.75c.621 0 1.125-.504 1.125-1.125V9.375c0-.621-.504-1.125-1.125-1.125H8.25zM6.75 12h.008v.008H6.75V12zm0 3h.008v.008H6.75V15zm0 3h.008v.008H6.75V18z" />
                        </svg>
                    </div>
                    <h1>DXF Layer Validator</h1>
                </div>
                <p class="page-description">
                    Upload your DXF or ZIP file to validate layer names and colors against the master guidelines.
                </p>
            </div>
            
            <div class="container__body">
                {% if current_user.is_authenticated %}
                <div class="user-header">
                    <div class="user-info">
                        <div class="user-avatar">{{ current_user.username[:2].upper() }}</div>
                        <div class="user-name">{{ current_user.username }}</div>
                    </div>
                    <div class="user-actions">
                        <a href="{{ url_for('index') }}" class="btn btn--ghost btn--sm">Upload</a>
                        <a href="{{ url_for('list_versions') }}" class="btn btn--ghost btn--sm">History</a>
                        <a href="{{ url_for('compare_versions') }}" class="btn btn--ghost btn--sm">Compare</a>
                        {% if current_user.username == 'admin' %}
                        <a href="{{ url_for('admin') }}" class="btn btn--ghost btn--sm">Admin</a>
                        {% endif %}
                        <a href="{{ url_for('logout') }}" class="btn btn--secondary btn--sm">Logout</a>
                    </div>
                </div>
                {% endif %}
                {% with messages = get_flashed_messages(with_categories=true) %}
                    {% if messages %}
                        {% for category, message in messages %}
                            <div class="alert alert--{{ category }}">
                                {% if category == 'error' %}
                                <svg class="alert__icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m9-.75a9 9 0 11-18 0 9 9 0 0118 0zm-9 3.75h.008v.008H12v-.008z" />
                                </svg>
                                {% else %}
                                <svg class="alert__icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                                {% endif %}
                                <span>{{ message }}</span>
                            </div>
                        {% endfor %}
                    {% endif %}
                {% endwith %}
                
                <form method="POST" action="/upload" enctype="multipart/form-data" id="uploadForm">
                    <div class="upload-zone" id="uploadZone">
                        <svg class="upload-zone__icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5m-13.5-9L12 3m0 0l4.5 4.5M12 3v13.5" />
                        </svg>
                        <p class="upload-zone__title">Drop your file here or click to browse</p>
                        <p class="upload-zone__subtitle">Supports .dxf and .zip files up to 100 MB</p>
                        <input type="file" name="file" id="file" class="upload-zone__file" accept=".dxf,.zip" required>
                        
                        <div class="upload-zone__selected" id="selectedFile">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m2.25 0H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" />
                            </svg>
                            <span class="upload-zone__filename" id="fileName"></span>
                            <span class="upload-zone__size" id="fileSize"></span>
                            <button type="button" class="upload-zone__clear" id="clearFile" title="Remove file">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                                </svg>
                            </button>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="rules_source" class="form-label">Validation Guidelines</label>
                        <select name="rules_source" id="rules_source" class="form-select">
                            <option value="odisha" selected>Odisha Rules (Default)</option>
                            <option value="ppa">PPA Rules</option>
                            <option value="custom">Upload Custom Rules JSON</option>
                        </select>
                    </div>

                    <div class="form-group" id="customRulesGroup" style="display: none;">
                        <label for="custom_rules_file" class="form-label">Upload Rules JSON</label>
                        <input type="file" name="custom_rules_file" id="custom_rules_file" class="form-control" accept=".json">
                    </div>

                    <button type="submit" class="btn btn--primary btn--full" id="submitBtn" disabled>
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        Validate Layers
                    </button>
                </form>
                
                <div class="features">
                    <h3 class="features__title">Features</h3>
                    <ul class="features__list">
                        <li class="features__item">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" />
                            </svg>
                            DXF versions R12 to R2018+
                        </li>
                        <li class="features__item">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" />
                            </svg>
                            ZIP file auto-extraction
                        </li>
                        <li class="features__item">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" />
                            </svg>
                            Master guideline validation
                        </li>
                        <li class="features__item">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" />
                            </svg>
                            Entity-level color checks
                        </li>
                    </ul>
                </div>
                
                <a href="/admin" class="footer-link">Update Master Data</a>
            </div>
        </div>
    </div>
    
    <script>
        const uploadZone = document.getElementById('uploadZone');
        const fileInput = document.getElementById('file');
        const fileName = document.getElementById('fileName');
        const fileSize = document.getElementById('fileSize');
        const selectedFile = document.getElementById('selectedFile');
        const clearFile = document.getElementById('clearFile');
        const submitBtn = document.getElementById('submitBtn');
        const rulesSource = document.getElementById('rules_source');
        const customRulesGroup = document.getElementById('customRulesGroup');
        const customRulesFile = document.getElementById('custom_rules_file');
        
        // Handle rules source change
        rulesSource.addEventListener('change', function() {
            if (this.value === 'custom') {
                customRulesGroup.style.display = 'block';
                customRulesFile.required = true;
            } else {
                customRulesGroup.style.display = 'none';
                customRulesFile.required = false;
                customRulesFile.value = ''; // clear selection
            }
        });
        
        // Format bytes to human readable
        function formatBytes(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        // Update UI when file is selected
        function updateFileDisplay(file) {
            if (file) {
                fileName.textContent = file.name;
                fileSize.textContent = formatBytes(file.size);
                selectedFile.classList.add('active');
                uploadZone.classList.add('upload-zone--active');
                submitBtn.disabled = false;
            } else {
                selectedFile.classList.remove('active');
                uploadZone.classList.remove('upload-zone--active');
                submitBtn.disabled = true;
            }
        }
        
        // File input change handler
        fileInput.addEventListener('change', function(e) {
            updateFileDisplay(this.files[0]);
        });
        
        // Clear file button
        clearFile.addEventListener('click', function(e) {
            e.stopPropagation();
            fileInput.value = '';
            updateFileDisplay(null);
        });
        
        // Click on zone to trigger file input
        uploadZone.addEventListener('click', function(e) {
            if (e.target !== clearFile && !clearFile.contains(e.target)) {
                fileInput.click();
            }
        });
        
        // Drag and drop handling
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            uploadZone.addEventListener(eventName, preventDefaults, false);
        });
        
        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }
        
        ['dragenter', 'dragover'].forEach(eventName => {
            uploadZone.addEventListener(eventName, () => {
                uploadZone.classList.add('upload-zone--dragover');
            });
        });
        
        ['dragleave', 'drop'].forEach(eventName => {
            uploadZone.addEventListener(eventName, () => {
                uploadZone.classList.remove('upload-zone--dragover');
            });
        });
        
        uploadZone.addEventListener('drop', function(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            
            if (files.length > 0) {
                const file = files[0];
                const ext = file.name.split('.').pop().toLowerCase();
                
                if (ext === 'dxf' || ext === 'zip') {
                    fileInput.files = files;
                    updateFileDisplay(file);
                } else {
                    alert('Please upload a .dxf or .zip file');
                }
            }
        });
    </script>
</body>
</html>
